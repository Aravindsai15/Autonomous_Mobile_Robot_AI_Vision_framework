<launch>
  <!-- ============================================= -->
  <!-- 0. Performance Optimization -->
  <!-- ============================================= -->
  <env name="LD_PRELOAD" value="/usr/lib/aarch64-linux-gnu/libgomp.so.1"/>
  <env name="OMP_NUM_THREADS" value="1"/>
  <env name="MKL_NUM_THREADS" value="1"/>
  <env name="OPENBLAS_NUM_THREADS" value="1"/>
  <env name="LIBVA_DRIVER_NAME" value="nvidia"/>
  <env name="FFMPEG_HWACCEL" value="cuda"/>

  <!-- ============================================= -->
  <!-- 1. Static Transforms (Optimized) -->
  <!-- ============================================= -->

  <node pkg="tf" type="static_transform_publisher" name="odom_to_base_tf"
        args="0 0 0 0 0 0 odom base_link 100"/>
  <node pkg="tf" type="static_transform_publisher" name="tf_base_to_imu"
        args="0.1 0 0.2 0 0 0 base_link imu_link 100"/>
  <node pkg="tf" type="static_transform_publisher" name="camera_tf"
        args="0 0 0.5 0 0 0 base_link camera_color_optical_frame 100"/>
  <node pkg="tf" type="static_transform_publisher" name="base_to_gps"
        args="0 0 0 0 0 0 base_link gps 100"/>
  <node pkg="tf" type="static_transform_publisher" name="utm_to_odom_tf"
        args="0 0 0 0 0 0 utm odom 100"/>
  <node pkg="tf" type="static_transform_publisher" name="map_to_base_tf"
        args="0 0 0 0 0 0 map base_link 100"/>

  <!-- ============================================= -->
  <!-- 2. Sensor Nodes (Optimized) -->
  <!-- ============================================= -->

  <!-- USB Camera Node with reduced frame rate -->
  <node pkg="usb_cam" type="usb_cam_node" name="usb_cam" output="screen" respawn="true">
    <param name="video_device" value="/dev/video0"/>
    <param name="camera_frame_id" value="camera_link"/>
    
    <!-- Reduced resolution and frame rate -->
    <param name="image_width" value="640"/>
    <param name="image_height" value="480"/>
    <param name="framerate" value="5"/>  <!-- Reduced from 15 to 10 FPS -->
    
    <param name="pixel_format" value="yuyv"/>
    <param name="camera_info_url" value="file://$(find usb_cam)/camera_info/camera.yaml"/>
    <param name="camera_name" value="usb_cam"/>
    <remap from="/usb_cam/image_raw" to="camera/color/image_raw"/>
  </node>

  <!-- Throttle node to further reduce frame rate if needed -->
  <node pkg="topic_tools" type="throttle" name="camera_throttle" 
        args="messages /camera/color/image_raw 3 /camera/color/image_raw_throttled">
  </node>

  <!-- ============================================= -->
  <!-- 3. GPU-Accelerated Image Conversion (image_proc) -->
  <!-- ============================================= -->
  <node pkg="image_proc" type="image_proc" name="image_proc" output="screen">
    <!-- Use throttled image stream -->
    <remap from="image_raw" to="/camera/color/image_raw_throttled"/>
    <param name="queue_size" value="2"/>
  </node>

  <!-- ============================================= -->
  <!-- 4. IMU Node (Updated remappings) -->
  <!-- ============================================= -->
  <node pkg="autobot_ai" type="imu_9axis_node.py" name="imu_9axis_node" output="screen">
      <param name="i2c_bus" value="1"/>
      <param name="i2c_address" value="40"/>
      <param name="frame_id" value="imu_link"/>
      <param name="publish_rate" value="10.0"/>
      <param name="orientation_covariance" value="0.05"/>
      <param name="angular_velocity_covariance" value="0.02"/>
      <param name="linear_acceleration_covariance" value="0.04"/>
      <!-- Changed to match what EKF expects -->
      <remap from="/sensors/imu/data" to="/imu/data"/>
      <remap from="/imu/mag" to="/mag"/>
  </node>

  <!-- ============================================= -->
  <!-- 5. AI Vision Node with Frame Skipping -->
  <!-- ============================================= -->
  <node pkg="autobot_ai" type="amr_ai_vision_node.py" name="amr_ai_vision_node" output="screen">
    <param name="use_gpu" value="true"/>
    <param name="process_rate" value="5"/>
    <rosparam param="ipm_size">[160, 160]</rosparam>
    <param name="ipm_resolution" value="0.05"/>
    <param name="enable_ipm" value="true"/>
    <param name="debug_mode" value="true"/>
    
    <!-- Critical Fix: Proper remapping to throttled stream -->
    <remap from="/camera/image_raw" to="/camera/color/image_raw_throttled"/>
    
    <remap from="/localization/filtered_odom" to="/odometry/gps"/>
    <remap from="/semantic_costmap" to="/semantic_map"/>
  </node>

  <!-- ============================================= -->
  <!-- 6. Delayed EKF Filter (robot_localization) -->
  <!-- ============================================= -->
  <node pkg="robot_localization" type="ekf_localization_node" name="ekf_filter_node"
        launch-prefix="bash -c 'sleep 5.0; $0 $@'" output="screen">
      <param name="world_frame" value="map"/>
      <param name="frequency" value="10.0"/>
      <param name="sensor_timeout" value="1.0"/>
      <param name="two_d_mode" value="true"/>
      <param name="odom_frame" value="odom"/>
      <param name="base_link_frame" value="base_link"/>
      <!-- Corrected IMU topic -->
      <param name="imu0" value="/imu/data"/>
      <!-- Updated configuration to use angular velocity and linear acceleration -->
      <rosparam param="imu0_config">[false, false, false, 
                                    true, true, true,  <!-- angular velocity -->
                                    true, true, true,  <!-- linear acceleration -->
                                    false, false, false]</rosparam>
      <param name="odom0" value="/odometry/gps"/>
      <rosparam param="odom0_config">[true, true, false, false, false, false, false, false, false]</rosparam>
      <param name="use_odometry_yaw" value="false"/>
      <param name="print_diagnostics" value="true"/>
      <param name="transform_timeout" value="0.2"/>
      <param name="transform_time_offset" value="0.1"/>
      <remap from="odometry/filtered" to="/localization/filtered_odometry"/>
  </node>

  <!-- ============================================= -->
  <!-- 7. Odomâ†’PoseStamped Converter -->
  <!-- ============================================= -->
  <node pkg="autobot_ai" type="odom_to_pose.py" name="odom_to_pose_node" output="screen">
    <remap from="/input_odom" to="/localization/filtered_odometry"/>
    <remap from="/output_pose" to="/localization/filtered_odom"/>
  </node>

  <!-- ============================================= -->
  <!-- 8. GPS â†’ Cartesian Transform (robot_localization) -->
  <!-- ============================================= -->
  <node pkg="robot_localization" type="navsat_transform_node" name="navsat_transform_node" output="screen">
      <param name="world_frame" value="map"/>
      <param name="utm_frame" value="utm"/>
      <param name="utm_zone" value="32N"/>
      <rosparam param="datum">[48.0543062, 8.2031135, 0.0]</rosparam>
      <param name="broadcast_cartesian_transform" value="true"/>
      <param name="use_local_cartesian" value="false"/>
      <param name="zero_altitude" value="true"/>
      <param name="position_covariance_type" value="3"/>
      <param name="delay" value="5.0"/>
      <param name="wait_for_datum" value="true"/>
      <param name="publish_filtered_gps" value="true"/>
      <!-- Corrected IMU topic remapping -->
      <remap from="imu/data" to="/imu/data"/>
      <remap from="gps/fix" to="/sensors/gps/fix"/>
      <remap from="odometry/gps" to="/odometry/gps"/>
      <remap from="odometry/filtered" to="/localization/filtered_odometry"/>
  </node>

  <!-- ============================================= -->
  <!-- 9. Auto Navigation Node (autobot_ai) -->
  <!-- ============================================= -->
  <node pkg="autobot_ai" type="auto_navigation.py" name="auto_navigation_node" output="screen">
    <param name="local_costmap_topic" value="/semantic_map"/>
    <param name="goal_tolerance" value="0.5"/>
    <param name="replan_interval" value="10.0"/>
    <param name="assumed_speed" value="0.5"/>
    <param name="max_dead_reckoning_distance" value="50.0"/>
    <remap from="/odom" to="/localization/filtered_odometry"/>
    <remap from="/goal_pose" to="/goal_pose"/>
    <remap from="/cmd_vel" to="/nav_vel"/>
    <remap from="/global_path" to="/navigation/global_path"/>
  </node>

  <!-- ============================================= -->
  <!-- 10. RViz and Diagnostics -->
  <!-- ============================================= -->
  <node pkg="rviz" type="rviz" name="rviz" args="-d $(find autobot_ai)/rviz/ai_vision.rviz" output="screen"/>
  <node pkg="rqt_graph" type="rqt_graph" name="rqt_graph"/>
  <node pkg="rqt_topic" type="rqt_topic" name="rqt_topic"/>
</launch>
